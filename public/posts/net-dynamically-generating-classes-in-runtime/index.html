<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>NET Dynamically Generating Classes in Runtime</title>
    <meta name="description" content="Code · Architecture · Design">
    <meta name="keywords" content='blog, software, nlukovic, nikolalukovic, programming, react, js, javascript, css, html, go, golang, .net, dotnet, dotnetcore, aspnetcore, itekako, nikola, lukovic, luković, nikola lukovic, nikola luković, nikola.lukovic, nikola.lukovic@live.com, dlr, dynamic, assembly'>

    <meta property="og:url" content="http://localhost:1313/posts/net-dynamically-generating-classes-in-runtime/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="NET Dynamically Generating Classes in Runtime">
    <meta property="og:description" content="Code · Architecture · Design">
    <meta property="og:image" content="http://localhost:1313/images/dynamic-assembly.png">
    <meta property="og:image:secure_url" content="http://localhost:1313/images/dynamic-assembly.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NET Dynamically Generating Classes in Runtime">
    <meta name="twitter:description" content="Code · Architecture · Design">
    <meta property="twitter:domain" content="http://localhost:1313/posts/net-dynamically-generating-classes-in-runtime/">
    <meta property="twitter:url" content="http://localhost:1313/posts/net-dynamically-generating-classes-in-runtime/">
    <meta name="twitter:image" content="http://localhost:1313/images/dynamic-assembly.png">

    
    <link rel="canonical" href="http://localhost:1313/posts/net-dynamically-generating-classes-in-runtime/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.315e3e4471e2465f34b6c92d59edceac6f6b3d3844df51bbaac4e5f7227b04e4.js" integrity="sha256-MV4&#43;RHHiRl80tsktWe3OrG9rPThE31G7qsTl9yJ7BOQ="></script>

    
    
        <script defer data-domain="nikolalukovic.com" src="https://plausible.io/js/plausible.js"></script>

    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="http://localhost:1313/">
                <img src='https://avatars.githubusercontent.com/u/6897673?v=4' alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="http://localhost:1313/">A Blog</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="http://localhost:1313/"> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:1313/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:1313/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/nikolalukovic"><span data-feather='github'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://www.linkedin.com/in/nikola-lukovic-89a17595"><span data-feather='linkedin'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://hachyderm.io/@nikola"><span data-feather='external-link'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://twitter.com/Kooraiber"><span data-feather='twitter'></span>  </a>
            </div>
            
            <div class="nav-link">
                <a href="https://bandcamp.com/nikolalukovic"><span data-feather='music'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="http://localhost:1313/"> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:1313/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:1313/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/nikolalukovic"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://www.linkedin.com/in/nikola-lukovic-89a17595"><span data-feather='linkedin'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://hachyderm.io/@nikola"><span data-feather='external-link'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://twitter.com/Kooraiber"><span data-feather='twitter'></span>  </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://bandcamp.com/nikolalukovic"><span data-feather='music'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>NET Dynamically Generating Classes in Runtime</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">March 23, 2017
        
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="http://localhost:1313/tags/.net">.net</a></li>
        
            <li class="post-tag"><a href="http://localhost:1313/tags/dlr">dlr</a></li>
        
            <li class="post-tag"><a href="http://localhost:1313/tags/dynamic">dynamic</a></li>
        
            <li class="post-tag"><a href="http://localhost:1313/tags/assembly">assembly</a></li>
        
            <li class="post-tag"><a href="http://localhost:1313/tags/programming">programming</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>Reflection API in .NET is one of the most powerful and incredible features of it. And along with <a href="https://en.wikipedia.org/wiki/Dynamic_Language_Runtime">DLR</a> it enables a whole new look at what can be done in .NET languages.<br>
One of problems i had to solve recently was how to create a unified <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for queries that could be used with most C# DB drivers(they had to have <a href="https://msdn.microsoft.com/en-us/library/system.linq.iqueryable(v=vs.110).aspx">IQueryable</a> support).<br>
It turned out to be simpler job than i thought. This <a href="https://github.com/kahanu/System.Linq.Dynamic">github project</a> helped me a lot to figure out how to solve it. One of the problems was how to execute <em>projections</em> from dbs and be able to get the information in runtime.</p>
<h2 id="overview">Overview</h2>
<p>Solution consists mainly from 4 parts:</p>
<ul>
<li>An abstract class that serves as a parent for further generation</li>
<li>A class that serves as an information about properties that will represent data fields</li>
<li>A class that&rsquo;s used as a <em>signature</em> for specified assemblies, since we&rsquo;re caching them(it will be explained why later)</li>
<li>A singleton factory class that generates, caches and returns dynamic assemblies</li>
</ul>
<h3 id="abstract-class">Abstract class</h3>
<p>It&rsquo;s just a regular empty abstract class that serves as a base for further assemblies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousClass</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="class-for-information-about-data-fields">Class for information about data fields</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousProperty</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span> name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Type type;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> AnonymousProperty(<span style="color:#66d9ef">string</span> name, Type type)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (String.IsNullOrWhiteSpace(name)) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(name));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (type == <span style="color:#66d9ef">default</span>(Type)) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(type));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.name = name;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.type = type;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name =&gt; <span style="color:#66d9ef">this</span>.name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Type Type =&gt; <span style="color:#66d9ef">this</span>.type;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="signature-class">Signature class</h3>
<p>A signature class is basically used as a <em>unique</em> hash of dynamically generated assemblies. It takes property names and property types from a generated assembly and <a href="https://en.wikipedia.org/wiki/Exclusive_or">XORs</a> their hash codes with it&rsquo;s own hash code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousClassSignature</span> : IEquatable&lt;AnonymousClassSignature&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AnonymousProperty[] properties;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> hashCode = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> AnonymousClassSignature(IEnumerable&lt;AnonymousProperty&gt; properties)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (properties == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(properties));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.properties = properties.ToArray();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> property <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">this</span>.properties)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.hashCode = <span style="color:#66d9ef">this</span>.hashCode ^ property.Name.GetHashCode() ^ property.Type.GetHashCode();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">int</span> GetHashCode() =&gt; <span style="color:#66d9ef">this</span>.hashCode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> Equals(<span style="color:#66d9ef">object</span> obj) =&gt; obj <span style="color:#66d9ef">is</span> AnonymousClassSignature ? <span style="color:#66d9ef">this</span>.Equals(obj <span style="color:#66d9ef">as</span> AnonymousClassSignature) : <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Equals(AnonymousClassSignature other)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (other == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(other));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.properties.Length != other.properties.Length) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#66d9ef">this</span>.properties.Length; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.properties[i].Name != other.properties[i].Name || <span style="color:#66d9ef">this</span>.properties[i].Type != other.properties[i].Type)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="singleton-factory-class">Singleton factory class</h3>
<p>This is a long one. It&rsquo;s a lazy initialized singleton class that serves as a factory generator of dynamicly created classes and it also holds a cache of already created ones. Caching is needed because dynamically generating a class has a huge performance hit. It uses both a <a href="https://msdn.microsoft.com/en-us/library/dd287191(v=vs.110).aspx">ConcurrentDictionary</a> and <a href="https://msdn.microsoft.com/en-us/library/system.threading.readerwriterlockslim(v=vs.110).aspx">ReaderWriterLockSlim</a> to synchronize access to generation and retrieval of dynamic classes.<br>
Steps to get a dynamic class basically goes like this:</p>
<ul>
<li>Create a list of properties you want a dynamic class to have, with a name and type</li>
<li>Give it to the factory</li>
<li>Factory creates a unique signature out of those properties and checks if it already exists in cache</li>
<li>If it exists retrieve it from cache</li>
<li>If not, use <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.typebuilder(v=vs.110).aspx">TypeBuilder</a> to create those properties, with backing fields and get_ , set_ methods for each one, cache it and return to the caller</li>
</ul>
<p><a href="https://msdn.microsoft.com/en-us/library/system.security.permissions.reflectionpermission(v=vs.110).aspx">ReflectionPermission</a> is because we need to generate private fields and that is not allowed by default, and basically any action that uses <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v=vs.110).aspx">Reflection.Emit</a> requires it.</p>
<p><a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.typebuilder(v=vs.110)">TypeBuilder</a> is basically just a wrapper around <a href="https://en.wikipedia.org/wiki/Common_Intermediate_Language">CIL</a> and currently it&rsquo;s the only way to have dynamically generated classes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnonymousAssemblyFactory</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> Lazy&lt;AnonymousAssemblyFactory&gt; Lazy = <span style="color:#66d9ef">new</span> Lazy&lt;AnonymousAssemblyFactory&gt;(() =&gt; <span style="color:#66d9ef">new</span> AnonymousAssemblyFactory(), LazyThreadSafetyMode.ExecutionAndPublication);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ModuleBuilder moduleBinder;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ConcurrentDictionary&lt;AnonymousClassSignature, Type&gt; classes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> classCount;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ReaderWriterLockSlim readerWriterLockSlim;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> AnonymousAssemblyFactory()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> assemblyName = <span style="color:#66d9ef">new</span> AssemblyName(<span style="color:#e6db74">&#34;SomeDll.AnonymousClasses&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> assemblyBuilder = AppDomain.CurrentDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.RunAndCollect);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> ENABLE_LINQ_PARTIAL_TRUST
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> ReflectionPermission(PermissionState.Unrestricted).Assert();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.moduleBinder = assemblyBuilder.DefineDynamicModule(<span style="color:#e6db74">&#34;SomeDll.DynamicModule&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> ENABLE_LINQ_PARTIAL_TRUST
</span></span><span style="display:flex;"><span>            PermissionSet.RevertAssert();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.classes = <span style="color:#66d9ef">new</span> ConcurrentDictionary&lt;AnonymousClassSignature, Type&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.classCount = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.readerWriterLockSlim = <span style="color:#66d9ef">new</span> ReaderWriterLockSlim();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> AnonymousAssemblyFactory Instance =&gt; Lazy.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Type GetAnonymousClass(IEnumerable&lt;AnonymousProperty&gt; properties)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (properties == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(properties));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.readerWriterLockSlim.EnterUpgradeableReadLock();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> signature = <span style="color:#66d9ef">new</span> AnonymousClassSignature(properties);
</span></span><span style="display:flex;"><span>            Type outType;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">this</span>.classes.TryGetValue(signature, <span style="color:#66d9ef">out</span> outType))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> ENABLE_LINQ_PARTIAL_TRUST
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> ReflectionPermission(PermissionState.Unrestricted).Assert();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.readerWriterLockSlim.EnterWriteLock();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">this</span>.classes.TryGetValue(signature, <span style="color:#66d9ef">out</span> outType))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> className = <span style="color:#e6db74">$&#34;SomeDll_AnonymousClass_{this.classCount++}&#34;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> typeBuilder = <span style="color:#66d9ef">this</span>.moduleBinder.DefineType(className, TypeAttributes.Class | TypeAttributes.Public, <span style="color:#66d9ef">typeof</span>(AnonymousClass));
</span></span><span style="display:flex;"><span>                    List&lt;FieldInfo&gt; fields;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.CreateAnonymousProperties(typeBuilder, properties.ToList(), <span style="color:#66d9ef">out</span> fields);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.CreateEqualsMethod(typeBuilder, fields);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.CreateGetHashCodeMethod(typeBuilder, fields);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> result = typeBuilder.CreateType();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.classes.TryAdd(signature, result);
</span></span><span style="display:flex;"><span>                    Interlocked.CompareExchange(<span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">this</span>.classCount, <span style="color:#66d9ef">this</span>.classes.Count, <span style="color:#66d9ef">this</span>.classes.Count);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> outType;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> outType;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> ENABLE_LINQ_PARTIAL_TRUST
</span></span><span style="display:flex;"><span>            PermissionSet.RevertAssert();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.readerWriterLockSlim.IsWriteLockHeld)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.readerWriterLockSlim.ExitWriteLock();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.readerWriterLockSlim.ExitUpgradeableReadLock();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CreateAnonymousProperties(TypeBuilder typeBuilder, List&lt;AnonymousProperty&gt; properties, <span style="color:#66d9ef">out</span> List&lt;FieldInfo&gt; fields)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (typeBuilder == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(typeBuilder));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (properties == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(properties));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fields = <span style="color:#66d9ef">new</span> List&lt;FieldInfo&gt;(properties.Count);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> anonProperty <span style="color:#66d9ef">in</span> properties)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> field = typeBuilder.DefineField(<span style="color:#e6db74">$&#34;_{anonProperty.Name}&#34;</span>, anonProperty.Type, FieldAttributes.Private);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> property = typeBuilder.DefineProperty(anonProperty.Name, PropertyAttributes.HasDefault, anonProperty.Type, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> getter = typeBuilder.DefineMethod(<span style="color:#e6db74">$&#34;get_{anonProperty.Name}&#34;</span>, MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span>[] { anonProperty.Type });
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> setter = typeBuilder.DefineMethod(<span style="color:#e6db74">$&#34;set_{anonProperty.Name}&#34;</span>, MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span>[] { anonProperty.Type });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> getterGenerator = getter.GetILGenerator();
</span></span><span style="display:flex;"><span>            getterGenerator.Emit(OpCodes.Ldarg_0);
</span></span><span style="display:flex;"><span>            getterGenerator.Emit(OpCodes.Ldfld, field);
</span></span><span style="display:flex;"><span>            getterGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> setterGenerator = setter.GetILGenerator();
</span></span><span style="display:flex;"><span>            setterGenerator.Emit(OpCodes.Ldarg_0);
</span></span><span style="display:flex;"><span>            setterGenerator.Emit(OpCodes.Ldarg_1);
</span></span><span style="display:flex;"><span>            setterGenerator.Emit(OpCodes.Stfld, field);
</span></span><span style="display:flex;"><span>            setterGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            property.SetGetMethod(getter);
</span></span><span style="display:flex;"><span>            property.SetSetMethod(setter);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            fields.Add(field);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CreateEqualsMethod(TypeBuilder typeBuilder, List&lt;FieldInfo&gt; fields)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (typeBuilder == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(typeBuilder));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (fields == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(fields));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> method = typeBuilder.DefineMethod(<span style="color:#e6db74">&#34;Equals&#34;</span>, MethodAttributes.Public | MethodAttributes.ReuseSlot | MethodAttributes.Virtual | MethodAttributes.HideBySig, <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">bool</span>), <span style="color:#66d9ef">new</span>[] { <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">object</span>) });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> methodGenerator = method.GetILGenerator();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> other = methodGenerator.DeclareLocal(typeBuilder);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> next = methodGenerator.DefineLabel();
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ldarg_1);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Isinst, typeBuilder);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Stloc, other);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ldloc, other);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Brtrue_S, next);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ldc_I4_0);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>        methodGenerator.MarkLabel(next);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> field <span style="color:#66d9ef">in</span> fields)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> comparerType = <span style="color:#66d9ef">typeof</span>(EqualityComparer&lt;&gt;).MakeGenericType(field.FieldType);
</span></span><span style="display:flex;"><span>            next = methodGenerator.DefineLabel();
</span></span><span style="display:flex;"><span>            methodGenerator.EmitCall(OpCodes.Call, comparerType.GetMethod(<span style="color:#e6db74">&#34;get_Default&#34;</span>), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldarg_0);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldfld, field);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldloc, other);
</span></span><span style="display:flex;"><span>            methodGenerator.EmitCall(OpCodes.Callvirt, comparerType.GetMethod(<span style="color:#e6db74">&#34;Equals&#34;</span>, <span style="color:#66d9ef">new</span>[] { field.FieldType, field.FieldType }), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Brtrue_S, next);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldc_I4);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>            methodGenerator.MarkLabel(next);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ldc_I4_1);
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CreateGetHashCodeMethod(TypeBuilder typeBuilder, List&lt;FieldInfo&gt; fields)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (typeBuilder == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(typeBuilder));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (fields == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(nameof(fields));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> method = typeBuilder.DefineMethod(<span style="color:#e6db74">&#34;GetHashCode&#34;</span>, MethodAttributes.Public | MethodAttributes.ReuseSlot | MethodAttributes.Virtual | MethodAttributes.HideBySig, <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">int</span>), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> methodGenerator = method.GetILGenerator();
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ldc_I4_0);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> field <span style="color:#66d9ef">in</span> fields)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> comparerType = <span style="color:#66d9ef">typeof</span>(EqualityComparer&lt;&gt;).MakeGenericType(field.FieldType);
</span></span><span style="display:flex;"><span>            methodGenerator.EmitCall(OpCodes.Call, comparerType.GetMethod(<span style="color:#e6db74">&#34;get_Default&#34;</span>), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldarg_0);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Ldfld, field);
</span></span><span style="display:flex;"><span>            methodGenerator.EmitCall(OpCodes.Callvirt, comparerType.GetMethod(<span style="color:#e6db74">&#34;GetHashCode&#34;</span>, <span style="color:#66d9ef">new</span>[] { field.FieldType }), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            methodGenerator.Emit(OpCodes.Xor);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        methodGenerator.Emit(OpCodes.Ret);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
        
    </div>

    <div class="prev-next">
        
    </div>

    
    
    
</div>



    

        </main><footer class="footer">
    
    

    
    <span>&copy; 2024 Nikola Luković</span>
    
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
